# *** Common configuration for interactive shells (shared by bash/zsh) ***

# ALIASES :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Create intermediate directories automatically w/ verbose output.
alias mkdir="mkdir -pv"

# Automatically cd to directory after it is created.
alias mkcd='_(){ mkdir $1; cd $1; }; _'

# List all files with long, human-readable info.
alias l='ls -lAhF'

# short-form for common commands
[[ `command -v bundle` ]] && alias b=bundle
[[ `command -v docker` ]] && alias d=docker
[[ `command -v docker` ]] && alias i="docker image"
[[ `command -v docker` ]] && alias c="docker container"
[[ `command -v docker-compose` ]] && alias dcom=docker-compose
[[ `command -v git` ]] && alias g=git
[[ `command -v kill` ]] && alias k=kill
[[ `command -v sudo` ]] && alias s=sudo
[[ `command -v tmux` ]] && alias t=tmux
[[ `command -v vim` ]] && alias v=vim
# m: preferred file-manager w/ fallbacks
[[ `command -v mc` ]] && alias m=mc
[[ `command -v ranger` ]] && alias m="source ranger" # source embedded script to cd on exit
# r: preferred grep w/ fallbacks
# rh: include hidden files/folders
[[ `command -v grep` ]] && alias r="grep -inr --color=auto" rh="r"
[[ `command -v ack` ]] && alias r="ack --smart-case -r" rh="r"
[[ `command -v ag` ]] && alias r="ag -Sr" rh="r --hidden" # -u to search ignored files
[[ `command -v rg` ]] && alias r="rg -S" rh="r --hidden" # -u to search ignored files
# f: regex find w/ fallbacks
# fh: include hidden files/folders
# (fallbacks implemented via ~/bin/f to support reordering of parameters)
if [[ `command -v fd` ]] ;then
  alias f=fd
  alias fh="f -HI"
fi

# short-form for built-in commands
alias e=echo
alias h=history
alias q=exit
alias ..='cd ../'
alias ...='cd ../../'
alias ....='cd ../../../'
alias .....='cd ../../../../'
alias ......='cd ../../../../../'


# FUNCTIONS :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Convert to all lowercase characters.
lowercase() {
    echo "$1" | tr 'A-Z' 'a-z'
}  

# Convert to all uppercase characters.
uppercase() {
    echo "$1" | tr 'a-z' 'A-Z'
}  

# Remove spaces.
nospaces() {
    echo "${1// /}"
}  

# Convert spaces to dashes.
dashws() {
    echo ""${1// /-}""
}  

# Convert spaces to underscores.
underscorews() {
    "echo ${1// /_}"
}  

# Remove dashes.
nodashes() {
    echo "${1//-/}"
}  

# Remove parens.
noparens() {
    echo "${1//[\(\)]/}"
}  

# Remove non-alphanumeric characters.
alphanum() {
    echo "${1//[^ _a-zA-Z0-9]/}"
}  

# Remove non-alphanumeric characters. (Keeping dashes)
alphanumdash() {
    echo "${1//[^ -_a-zA-Z0-9]/}"
}  

# Convert to safe user ID string.
userID() {
    : `nospaces "$1"`
    : `noparens "$_"`
    : `alphanum "$_"`
    : `lowercase "$_"`
    echo "$_"
}

# Convert to safe project ID string.
projID() {
    : `nospaces "$1"`
    : `noparens "$_"`
    : `alphanumdash "$_"`
    : `lowercase "$_"`
    echo "$_"
}

# Convert to safe package ID string.
pkgID() {
    : `nospaces "$1"`
    : `noparens "$_"`
    : `projID "$_"`
    : `nodashes "$_"`
    echo "$_"
}


# LANGUAGE SUPPORT ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# *** NVM (Node Version Manager) ***
# https://github.com/creationix/nvm

# Set path to NVM and initialize. Requres fix for symlink into .dotfiles
# From CristianCantoro, 2018, https://github.com/creationix/nvm/issues/617
export NVM_DIR="$(realpath $HOME/.nvm)" 
[[ -s "$NVM_DIR/nvm.sh" ]] && . "$NVM_DIR/nvm.sh"  # This loads nvm
[[ -r "$NVM_DIR/bash_completion" ]] && \. "$NVM_DIR/bash_completion"


# *** Yarn (Node Dependency Manager) ***
# https://yarnpkg.com

# Set path to yarn
[[ -d "$HOME/.yarn/bin" ]] && export PATH="$HOME/.yarn/bin:$PATH"


# *** Ruby ***

# Add RVM to PATH for scripting. Make sure this is the last PATH variable change.
[[ -d "$HOME/.rvm/bin" ]] && export PATH="$PATH:$HOME/.rvm/bin"

# Load RVM into a shell session *as a function*
[[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm"


###############################################################################


# INTERACTIVE SHELL CONFIG ::::::::::::::::::::::::::::::::::::::::::::::::::::

# EXIT if not running interactively.
[[ $- != *i* ]] && return


# *** Options ***

# Make Ctrl-s and Ctrl-q available for mappings
# Prevents default behavior where they suspend and resume terminal client
stty -ixon
# Alternately, remap to different keys as below
# stty stop ''
# stty start ''

# Change paths without using 'cd' command
[[ `type shopt` == *'builtin'* ]] && shopt -s autocd # bash
[[ `type setopt 2>/dev/null` == *'builtin'* ]] && setopt autocd  # zsh

# Increase terminal colors.
[[ -n "$DISPLAY" && "$TERM" = "xterm" ]] && export TERM=xterm-256color


# *** Liquid Prompt ***
# https://github.com/nojhan/liquidprompt

source ~/liquidprompt/liquidprompt


# *** Tmux ***
# https://wiki.archlinux.org/index.php/Tmux

# Attach to existing deattached session or start a new session.
if [[ `command -v tmux` && -z "$TMUX" ]] ;then
    ID="`tmux ls | grep -vm1 attached | cut -d: -f1`" # get the id of a deattached session
    if [[ -z "$ID" ]] ;then # if not available create a new one
        tmux new-session
    else
        tmux attach-session -t "$ID" # if available attach to it
    fi
fi


# *** Pager ***

# Override default pager
[[ -x "$HOME/bin/pager" ]] && export PAGER="$HOME/bin/pager"
alias less="$PAGER"
alias zless="$PAGER"


# EXTENDED CONFIGURATION ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Source personal profile, if present.
[[ -r ~/.personal.sh ]] && . ~/.personal.sh

# Source work profile, if present.
[[ -r ~/.work.sh ]] && . ~/.work.sh


